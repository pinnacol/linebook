fail () {
  echo "$TEST_CASE:$lineno $TEST_NAME" 1>&2
  echo "$1\n" 1>&2
  return 1
}

assert_status_equal () {
  expected=$1; actual=$2; lineno=$3

  if [ $actual -ne $expected ]
  then
    fail "expected exit status $expected but was $actual"
  fi
}

assert_output_equal () {
  expected=$(cat); actual=$1; lineno=$2

  if [ "$actual" != "$expected" ]
  then
    echo -e "$expected" > "$0_$2_expected.txt"
    echo -e "$actual"   > "$0_$2_actual.txt"
    
    fail "unequal output:\n$(diff "$0_$2_expected.txt" "$0_$2_actual.txt")"
    
    rm "$0_$2_expected.txt" "$0_$2_actual.txt"
    return 1
  fi
}

assert_equal () {
  assert_status_equal $1 $? $3 && 
  assert_output_equal "$2" $3
}

run_tests () {
  test_file=$1
  
  for test_method in $(grep -oE "^ *${NAME:-test_\w+} +\(\)" "$test_file" | tr -d " ()")
  do
    if TEST_NAME="$test_method" "$test_method"
    then printf '.'
    else printf 'F'
    fi
  done
}