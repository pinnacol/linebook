# Generated by Linecook

module Linebook
  module Os
    # Defines Linux-compliant functionality, based on the {Linux Standard Base
    # Core Specification 4.1 }[http://refspecs.linuxfoundation.org/lsb.shtml]. See
    # the online documentation for:
    #
    # * {Commands and Utilities
    #   }[http://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/cmdbehav.html]
    # * {Single Unix Specification V2
    #   }[http://pubs.opengroup.org/onlinepubs/007908799/xcuix.html]
    # Posix does not specify commands for user management, but Linux does. Now
    # that users are overtly in the mix, see {How to Switch
    # Users}[link:files/HowTo/Switch%20Users.html] for picking a su policy.
    module Linux
      require 'linebook/os/posix'
      include Posix
      
      require 'linebook/os/linux/utilities'
      include Utilities
      
      def guess_target_name(source_name)
        target_dir  = File.dirname(target_name)
        name = File.basename(source_name)
        
        _package_.next_target_name(target_dir == '.' ? name : File.join(target_dir, name))
      end
      
      def capture_script(options={})
        unless options.kind_of?(Hash)
          options = {:target_name => guess_target_name(options)}
        end
      
        target_name = options[:target_name] || guess_target_name('script')
        path = capture_path(target_name, options[:mode] || 0770) { yield }
      
        owner, group = options[:owner], options[:group]
        if owner || group
          callback 'before' do
            chown owner, group, path
          end
        end
      
        path
      end
      
      # Logs in as the specified user for the duration of a block (the current ENV
      # and pwd are reset as during a normal login).
      def login(user='root', options={})
        current = functions
        begin
          @functions = nil
          
          path = capture_script(options) { yield }
          execute 'su', user, path, :l => true
        ensure
          @functions = current
        end
        chain_proxy
      end
      
      def _login(*args, &block) # :nodoc:
        str = capture_str { login(*args, &block) }
        str.strip!
        str
      end
    end
  end
end
